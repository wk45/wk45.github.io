<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Woo Min Kim">
<meta name="dcterms.date" content="2018-05-05">

<title>HLSVD</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="HLSVD_files/libs/clipboard/clipboard.min.js"></script>
<script src="HLSVD_files/libs/quarto-html/quarto.js"></script>
<script src="HLSVD_files/libs/quarto-html/popper.min.js"></script>
<script src="HLSVD_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="HLSVD_files/libs/quarto-html/anchor.min.js"></script>
<link href="HLSVD_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="HLSVD_files/libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="HLSVD_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="HLSVD_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="HLSVD_files/libs/bootstrap/bootstrap-e19dc0c07aeef78048e587c3f1edba7a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">HLSVD</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Woo Min Kim </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 5, 2018</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="hierarchical-latent-svd-model" class="level1">
<h1>Hierarchical Latent SVD Model</h1>
<p>As an extended idea of latent distance models (LDM), the latent eigenmodel was introduced to capture both homophily and stochastic equivalence among nodes. The main difference between LDMs and eigenmodels is the choice of the function dependent on the latent space. More specifically, eigenmodels use <span class="math inline">\(a(u_i,u_j) = u_i^T\Lambda u_j\)</span> instead of mere physical distance function. Besides, all latent class, distance and eigenmodels only deal with the symmetric function <span class="math inline">\(d\)</span> or <span class="math inline">\(a\)</span>. However; the function also can be asymmetric if there exist sender and receiver effects are different. It is so-called SVD model, and the model specification is as follows:</p>
<p><span class="math display">\[\text{logit}P(Y_{ij}=1) = \beta^TX_{ij} + a_i + b_j + u_i^Tv_j +
\epsilon_{ij}\]</span></p>
<p>where <span class="math inline">\(u\)</span> and <span class="math inline">\(v\)</span> are vectors of latent nodal attributes, and <span class="math inline">\(a_i\)</span> and <span class="math inline">\(b_i\)</span> are terms for nodal heterogeneity.</p>
<section id="mcmc-derivation" class="level2">
<h2 class="anchored" data-anchor-id="mcmc-derivation">MCMC Derivation</h2>
<p><span class="math display">\[\begin{align*}
\mathbf{Y}_{ijk} &amp;= \mathbb{1}_{[\mathbf{Z}_{ijk}&gt;0]}\\
\mathbf{Z}_{ijk} &amp;= \sum_{p=0}^{P}\beta_{pk}^T\mathbf{X}_{ijpk} + a_{ik} + b_{jk} + u_{ik}^Tv_{jk} + \epsilon_{ijk}\\
(a_{ik}, b_{ik}) &amp;\stackrel{iid}{\sim} MVN_2((0,0), \mathbf{\Sigma}_{ab})\\
(u_{ik}, v_{ik}) &amp;\stackrel{iid}{\sim} MVN_4((0,0,0,0), \mathbf{\Sigma}_{uv})\\
(\epsilon_{ijk}, \epsilon_{jik}) &amp;\stackrel{iid}{\sim} MVN_2\Big(
  \begin{pmatrix} 0 \\ 0 \end{pmatrix},\begin{pmatrix} 1 &amp; \rho_k \\ \rho_k &amp; 1 \end{pmatrix}\Big)\\
\beta_{p}  &amp;\sim N(\mu_p, \sigma_p^2)\\
\mu_p  &amp;\sim N(\lambda, \tau^2)\\
\sigma_p^2  &amp;\sim IG(\nu_0, S_0)\\
\mathbf{\Sigma}_{ab} &amp;\sim IWishart(\nu_{ab},S_{ab}^{-1})\\
\mathbf{\Sigma}_{uv} &amp;\sim IWishart(\nu_{uv},S_{uv}^{-1})\\
\end{align*}\]</span></p>
<section id="update-z_ijk-z_jik" class="level3">
<h3 class="anchored" data-anchor-id="update-z_ijk-z_jik">Update <span class="math inline">\(Z_{ijk}, Z_{jik}\)</span>:</h3>
<p><span class="math display">\[\begin{align*}
(\mathbf{Z}_{ijk}, \mathbf{Z}_{jik}) &amp;\stackrel{iid}{\sim} MVN_2\Big(
  \begin{pmatrix} \sum_{p=0}^{P}\mathbf{X}_{ijpk}\beta_{pk} + a_{ik} + b_{jk} + u_{ik}^Tv_{jk} \\ \sum_{p=0}^{P}\mathbf{X}_{ijpk}\beta_{pk} + a_{jk} + b_{ik} + u_{jk}^Tv_{ik} \end{pmatrix},\begin{pmatrix} 1 &amp; \rho_k \\ \rho_k &amp; 1 \end{pmatrix}\Big)\\
\end{align*}\]</span></p>
<p>Let <span class="math inline">\(\eta_{ijk} = \sum_{p=0}^{P}\mathbf{X}_{ijpk}\beta_{pk} + a_{ik} + b_{jk} + u_{ik}^Tv_{jk}\)</span></p>
<p><span class="math display">\[\begin{align*}
\mathbf{Z}_{ijk}\mid \mathbf{Z}_{jik} &amp;\sim N(\eta_{ijk} + \rho_k\cdot(\mathbf{Z}_{jik} - \eta_{jik}), 1 - \rho_k^2)\\
\\
\text{Pr}(\mathbf{Z}_{ijk} \mid  \mathbf{Z}_{jik}, \mathbf{Y}_{ijk} = 1, \cdots) &amp;\propto \text{Pr}(\mathbf{Y}_{ijk} = 1 \mid  \cdots) \cdot \text{Pr}(\mathbf{Z}_{ijk} \mid  \mathbf{\mathbf{Z}}_{jik})\\
&amp;= \left\{
\begin{array}{c l}  
     \mathbb{1}_{[\mathbf{Z}_{ijk} &gt; 1]} \cdot dN(\mathbf{Z}_{ijk}; \eta_{ijk} + \rho_k\cdot(\mathbf{Z}_{jik} - \eta_{jik}), 1 - \rho_k^2 ) \text{ if } Y_{ijk} = 1\\
     \mathbb{1}_{[\mathbf{Z}_{ijk} &lt; 1]} \cdot dN(\mathbf{Z}_{ijk}; \eta_{ijk} + \rho_k\cdot(\mathbf{Z}_{jik} - \eta_{jik}), 1 - \rho_k^2 ) \text{ if } Y_{ijk} = 0
\end{array}\right.
\end{align*}\]</span></p>
</section>
<section id="update-beta_k" class="level3">
<h3 class="anchored" data-anchor-id="update-beta_k">Update <span class="math inline">\(\beta_{k}\)</span>:</h3>
<p>Let <span class="math inline">\(\bar{\mathbf{Z}}_{ijk} = \mathbf{Z}_{ijk} - a_{ik} - b_{jk} - u_{ik}^Tv_{jk}\)</span></p>
<p><span class="math display">\[\begin{align*}
\text{Pr}(\bar{\mathbf{Z}}_{ijk}) &amp;\propto \prod_{i \neq j}^{n_k}\exp\Bigg(-\frac{1}{2} \begin{pmatrix} \bar{\mathbf{Z}}_{ijk} - \sum_{p}\mathbf{X}_{ijpk}\beta_{pk}\\ \bar{\mathbf{Z}}_{jik} - \sum_{p}\mathbf{X}_{jipk}\beta_{pk} \end{pmatrix}^T \mathbf{\Sigma}_{\rho}^{-1} \begin{pmatrix} \bar{\mathbf{Z}}_{ijk} - \sum_{p}\mathbf{X}_{ijpk}\beta_{pk}\\ \bar{\mathbf{Z}}_{jik} - \sum_{p}\mathbf{X}_{jipk}\beta_{pk}  \end{pmatrix}\Bigg)\\%\cdot \text{dNorm}(\beta_k; \mu, \sigma^2)\\
\therefore \text{Pr}(\bar{\mathbf{Z}}_{ijk}\mid \bar{\mathbf{Z}}_{jik}) &amp;\sim N(\sum_{p}\mathbf{X}_{ijpk}\beta_{pk} + \rho_k(\bar{\mathbf{Z}}_{jik}- \sum_{p}\mathbf{X}_{jipk}\beta_{pk}), 1-\rho_k^2)\\
&amp;\propto \prod_{i \neq j} \exp\Bigg(-\frac{1}{2}\Big(\bar{Z}_{ijk} - \rho_k\sum_{p}\mathbf{X}_{jipk})\beta_{pk} - \rho_k(\bar{Z}_{jik} - X_{jik}\beta_k)\Big)^2 \cdot (1 - \rho_k^2)^{-1}\Bigg)\\
\therefore \text{Pr}(\beta_k \mid  \mathbf{Z}_k) &amp;\propto \prod_{i \neq j} \exp\Bigg(-\frac{1}{2} \Big( (X_{ijk} - \rho_k \sum_{p}\mathbf{X}_{jipk})\beta_{pk} - \bar{Z}_{ijk} - \rho_k \bar{Z}_{jik} \Big)^2 \cdot (1-\rho_k^2)^{-1}\Bigg) \cdot \text{dN}(\beta_k; \mu, \mathbf{\Sigma}_{\beta})\\
&amp;\propto
\exp{\Bigg(-\frac{1}{2}}(1-\rho_k^2)^{-1} \Big(\mathbf{\Theta}_{\beta} \vec{\beta}_k - \text{vec}(\mathbf{Z}_{k}) + \rho_k \text{vec}(\mathbf{Z}^T_{k})\Big)^T \Big(\mathbf{\Theta}_{\beta} \vec{\beta}_k - \text{vec}(\mathbf{Z}_{k}) + \rho_k \text{vec}(\mathbf{Z}^T_{k})\Big)\Bigg)\\
&amp;\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\,\, \times \exp{\Bigg(-\frac{1}{2}(\vec{\beta_k}-\vec{\mu})^T\mathbf{\Sigma}_\beta^{-1}(\vec{\beta_k}-\vec{\mu})\Bigg)}\\
\end{align*}\]</span> where <span class="math inline">\(\mathbf{\Theta}_{\beta}\)</span> is a vector length of <span class="math inline">\(n(n-1)\)</span>, and, <span class="math display">\[\mathbf{\Theta}_{\beta} = \Big(\begin{pmatrix}  | &amp; \cdots &amp; | \\ \text{vec}(\mathbf{X}_{1k}) &amp; \cdots  &amp;\text{vec}(\mathbf{X}_{Pk}) \\ | &amp; \cdots &amp; |\end{pmatrix} - \rho_k \begin{pmatrix}  | &amp; \cdots &amp; | \\ \text{vec}(\mathbf{X}^T_{1k}) &amp; \cdots  &amp;\text{vec}(\mathbf{X}^T_{Pk}) \\ | &amp; \cdots &amp; |\end{pmatrix} \Big)\]</span> Thus, we have <span class="math inline">\(\mathbf{V}_n = \mathbf{A}_n^{-1}\)</span> where <span class="math inline">\(\mathbf{A}_n = \mathbf{A}_0 + \mathbf{A}_1\)</span>, and <span class="math inline">\(\mathbf{A}_0 = \mathbf{\Sigma}_{\beta}^{-1}\)</span>, <span class="math inline">\(\mathbf{A}_1 = (1-\rho_k^2)^{-1}\mathbf{\Theta}_{\beta}^{T}\mathbf{\Theta}_{\beta}\)</span></p>
<p><span class="math inline">\(\mu_n = \mathbf{V}_nm_n\)</span> where <span class="math inline">\(m_n = m_0 + m_1\)</span>, and <span class="math inline">\(m_0 = \mathbf{\Sigma}_{\beta}^{-1}\mu\)</span> and <span class="math inline">\(m_1 = (1-\rho_k^2)^{-1}\mathbf{\Theta}_{\beta}^{T}\Big(\text{vec}(\mathbf{Z}_k) - \rho_k\text{vec}(\mathbf{Z}_k^T)\Big)\)</span></p>
</section>
<section id="update-a_ib_i" class="level3">
<h3 class="anchored" data-anchor-id="update-a_ib_i">Update <span class="math inline">\(a_i,b_i\)</span>:</h3>
<p>Let <span class="math inline">\(\hat{\mathbf{Z}}_{ijk} = \mathbf{Z}_{ijk} - \sum_{p}\mathbf{X}_{ijpk}\beta_{pk} - u_{ik}^Tv_{jk}\)</span></p>
<p><span class="math display">\[\begin{align*}
\text{Pr}\Bigg(\begin{pmatrix}a_{ik} \\ b_{ik}\end{pmatrix} \mid \begin{pmatrix} \hat{Z}_{ijk}\\ \hat{Z}_{jik} \end{pmatrix}, \dots\Bigg) &amp;\propto \\ &amp; \prod_{i \neq j}^{n_k}\exp\Bigg(-\frac{1}{2} \begin{pmatrix} \hat{Z}_{ijk} - a_{ik} - b_{jk}\\ \hat{Z}_{jik} - a_{jk}-b_{ik} \end{pmatrix}^T \Sigma_{\rho}^{-1} \begin{pmatrix} \hat{Z}_{ijk}-a_{ik}-b_{jk}\\ \hat{Z}_{jik}-a_{jk}-b_{ik} \end{pmatrix}\Bigg)\cdot \text{dMVN}_2\Bigg(\begin{pmatrix}a_{ik} \\ b_{ik}\end{pmatrix}; \begin{pmatrix} 0\\ 0\end{pmatrix}, \Sigma_{ab}\Bigg)\\
\therefore \text{Pr}(\hat{\mathbf{Z}}_{ijk}\mid \hat{\mathbf{Z}}_{jik}) &amp;\sim N(a_{ik} - (-b_{jk} - \rho_k(\hat{\mathbf{Z}}_{jik} - a_{jk} - b_{ik})), 1-\rho_k^2)\\
\therefore \text{Pr}(a_{ik}\mid \mathbf{Z}_k) &amp;\propto
\prod_{j \neq i}\exp\Bigg(-\frac{1}{2}(1- \rho_k^2)^{-1}(\hat{\mathbf{Z}}_{ijk} - a_{ik} - b_{jk} - \rho_k(\hat{\mathbf{Z}}_{jik} - a_{jk} - b_{ik}))^2\Bigg)\\
&amp; \,\,\,\,\,\,\,\,\,\,\,\, \cdot \text{dN}(a_{ik}\mid b_{ik}\,\, ; \,\, \mu_{a\mid b} = \mathbf{\Sigma}_{ab[1,2]}\mathbf{\Sigma}_{ab[2,2]}^{-1}b_{ik}, \,\, \sigma^2_{a\mid b} = \mathbf{\Sigma}_{ab[1,1]}-\mathbf{\Sigma}_{ab[1,2]}\mathbf{\Sigma}_{ab[2,2]}^{-1}\mathbf{\Sigma}_{ab[2,1]})\\
&amp;\propto \exp\Bigg(-\frac{1}{2}(1-\rho_k)^{-1}\sum_{j \neq i}(a_{ik} - \theta_{j})^{T}(a_{ik} - \theta_{j})\Bigg) \cdot \exp \Bigg(-\frac{1}{2}(a_{ik} - \mu_{a\mid b})^2 \sigma^{-2}_{a\mid b}\Bigg)\end{align*}\]</span></p>
<p><span class="math inline">\(\text{where } \theta_{j} = -b_{jk} - \rho_k(\hat{\mathbf{Z}}_{jik} - a_{jk} - b_{ik}) + \hat{\mathbf{Z}}_{ijk}\)</span> and <span class="math inline">\(i\)</span> is fixed. Then, we can easily figure out its posterior mean and variance.</p>
<p><span class="math inline">\(\mathbf{V}_n = \mathbf{A}_n^{-1} \text{ where } \mathbf{A}_n = \mathbf{A}_0 + \mathbf{A}_1, \text{ and } \mathbf{A}_0 = \sigma^{-2}_{a\mid b}, \mathbf{A}_1 = (n_k - 1)(1-\rho_k^2)^{-1}\)</span></p>
<p><span class="math inline">\(\mu_n = \mathbf{V}_nm_n\)</span> where <span class="math inline">\(m_n = m_0 + m_1\)</span>, and <span class="math inline">\(m_0 = \sigma_{a\mid b}^{-2}\mu_{a\mid b}\)</span> and <span class="math inline">\(m_1 = (1-\rho_k^2)^{-1}\sum_{j\neq i}{\theta}_{j}\)</span></p>
<p>Likewise, we can update <span class="math inline">\(b_{ik}\)</span>.</p>
</section>
<section id="update-u_i-v_i" class="level3">
<h3 class="anchored" data-anchor-id="update-u_i-v_i">Update <span class="math inline">\(u_i, v_i\)</span></h3>
<p>Let <span class="math inline">\(\tilde{Z}_{ijk} = Z_{ijk} - X_{ijk}\beta_k - a_{ik} - b_{jk}\)</span> <span class="math display">\[\begin{align*}
p\Bigg(\begin{pmatrix}u_{ik} \\ v_{ik}\end{pmatrix} \mid  \begin{pmatrix} \tilde{Z}_{ijk}\\ \tilde{Z}_{jik} \end{pmatrix},\dots \Bigg) &amp;\propto\\ &amp;\prod_{i \neq j}^{n_k}\exp\Bigg(-\frac{1}{2} \begin{pmatrix} \tilde{Z}_{ijk} - u_{ik}^Tv_{jk}\\ \tilde{Z}_{jik} - u_{ik}^Tv_{jk} \end{pmatrix}^T \Sigma_{\rho}^{-1} \begin{pmatrix} \tilde{Z}_{ijk}-u_{ik}^Tv_{jk}\\ \tilde{Z}_{jik}-u_{ik}^Tv_{jk} \end{pmatrix}\Bigg)\cdot \text{dMVN}_4\Bigg(\begin{pmatrix}u_{ik} \\ v_{ik}\end{pmatrix}; \begin{pmatrix} 0\\ 0\\0\\0\end{pmatrix}, \Sigma_{uvk}\Bigg)\\
\therefore \text{Pr}(\tilde{Z}_{ijk}\mid \tilde{Z}_{jik}) &amp;\sim \text{N}(u_{ik}^Tv_{jk} + \rho_k(\tilde{Z}_{jik}- u_{jk}^Tv_{ik}), 1-\rho_k^2)\\
\therefore \text{Pr}(u_{ik}\mid \tilde{Z}_k) &amp;\propto \prod_{j \neq i}\exp\Bigg(-\frac{1}{2}(1-\rho_k^2)^{-1}(\tilde{Z}_{ijk} - u_{ik}^Tv_{jk} - \rho_k(\tilde{Z}_{jik}-u_{jk}^Tv_{ik}))^2\Bigg)\\
&amp; \,\,\,\,\,\,\,\,\,\, \text{dMVN}_2(u_{ik}\mid v_{ik} \,\, ; \,\, \mu_{u\mid v} = \Sigma_{uv[1,2]}\Sigma_{uv[2,2]}^{-1}v_{ik}, \,\, \Sigma_{u\mid v} = \Sigma_{uv[1,1]} - \Sigma_{uv[1,2]}\Sigma_{uv[2,2]}^{-1} \Sigma_{uv[2,1]})\\
&amp;\propto \exp\Bigg(-\frac{1}{2}(1-\rho_k^2)^{-1}(\mathbf{\Theta}_{V}u_{ik}- \vec{\mu}_u)^T (\mathbf{\Theta}_{v}u_{ik}- \vec{\mu}_u)\Bigg) \cdot \exp\Bigg(-\frac{1}{2}(u_{ik}-\mu_{u\mid v})^T\Sigma_{u\mid v}(u_{ik}-\mu_{u\mid v})\Bigg)\\
\text{Where } &amp;\mathbf{\Theta}_{V} = \begin{pmatrix}  | &amp; | \\ \vec{v}_{jk[-i,1]} &amp; \vec{v}_{jk[-i,2]}   \\ | &amp; |\end{pmatrix} \text{ ,and } \vec{\mu}_u = \begin{pmatrix} | \\ \tilde{Z}_{i,\cdot,k} - \rho_k(\tilde{Z}_{\cdot,i,k} - u_{\cdot}^{T}v_{i})\\ | \end{pmatrix}\\
&amp;\text{, and dimensions are }(n_k-1)\times 2 \text{and } (n_k-1)\times 1, \text{respectively.}\\
\end{align*}\]</span> Then, we have <span class="math inline">\(\mathbf{V}_n = \mathbf{A}_n^{-1} \text{ where } \mathbf{A}_n = \mathbf{A}_0 + \mathbf{A}_1, \text{ and } \mathbf{A}_0 = \Sigma^{-1}_{u\mid v}, \mathbf{A}_1 = (1-\rho_k^2)^{-1}\mathbf{\Theta}_{V}^T\mathbf{\Theta}_{V}\)</span></p>
<p><span class="math inline">\(\mu_n = \mathbf{V}_nm_n\)</span> where <span class="math inline">\(m_n = m_0 + m_1\)</span>, and <span class="math inline">\(m_0 = \Sigma_{u\mid v}^{-1}\mu_{u\mid v}\)</span> and <span class="math inline">\(m_1 = (1-\rho_k^2)^{-1}\mathbf{\Theta}_{V}^T\vec{\mu}_u\)</span>.</p>
</section>
<section id="update-rho_k" class="level3">
<h3 class="anchored" data-anchor-id="update-rho_k">Update <span class="math inline">\(\rho_k\)</span></h3>
<p>Let <span class="math inline">\(\tilde{\epsilon}_{ijk} = Z_{ijk} - X_{ijk}\beta_k - a_{ik} - b_{jk}-  u_{ik}^Tv_{jk}\)</span></p>
<p><span class="math display">\[\begin{align*}
p\Bigg(\rho_k\mid  \begin{pmatrix} \tilde{\epsilon}_{ijk}\\ \tilde{\epsilon}_{jik} \end{pmatrix},\dots \Bigg) &amp;\propto \prod_{i \neq j}^{n_k}\exp\Bigg(-\frac{1}{2} \begin{pmatrix} \tilde{\epsilon}_{ijk}\\ \tilde{\epsilon}_{jik}\end{pmatrix}^T \Sigma_{\rho}^{-1} \begin{pmatrix} \tilde{\epsilon}_{ijk}\\ \tilde{\epsilon}_{jik} \end{pmatrix}\Bigg)\cdot \text{dUnif}(\rho_k; -1, 1)
\end{align*}\]</span> To update <span class="math inline">\(\rho_k\)</span>, Metropolis-Hastings is needed due to non-conjugacy.</p>
</section>
<section id="update-mu" class="level3">
<h3 class="anchored" data-anchor-id="update-mu">Update <span class="math inline">\(\mu\)</span></h3>
<p><span class="math display">\[\begin{align*}
p(\mu\mid \vec{Y}, \dots) &amp;\propto \prod_{k=1}^{K}\text{dNorm}(\beta_{k}; \mu, \sigma) \cdot \text{dNorm}(\mu;\lambda,\tau)\\
&amp;\sim \text{N}\left(\mu; \frac{\lambda/\tau + \sum_{k}\beta_{k}/\sigma^2}{(1\tau + K/\sigma^2)}, (1/\tau + K/\sigma^2)^{-1}\right)
\end{align*}\]</span></p>
</section>
<section id="update-sigma2" class="level3">
<h3 class="anchored" data-anchor-id="update-sigma2">Update <span class="math inline">\(\sigma^2\)</span></h3>
<p><span class="math display">\[\begin{align*}
p(\sigma^2\mid \vec{Y}, \dots) &amp;\propto \prod_{k=1}^{K}\text{dNorm}(\beta_{k}; \mu, \sigma) \cdot \text{dIG}(\sigma^2;\nu_0,S_0)\\
&amp;\sim \text{IG}\left(\sigma^2; \frac{\nu_0 + K}{2}, \frac{\nu_0 \cdot S_0 + \sum_k(\beta_{k}-\mu)^2}{2}\right)
\end{align*}\]</span></p>
</section>
<section id="update-sigma_ab" class="level3">
<h3 class="anchored" data-anchor-id="update-sigma_ab">Update <span class="math inline">\(\Sigma_{ab}\)</span>:</h3>
<p><span class="math display">\[\begin{align*}
p(\Sigma_{abk}\mid \vec{Y}, \dots) &amp;\propto \prod_{i=1}^{n_k}\text{dMVN}\Bigg(\begin{pmatrix} a_{ik}\\ b_{ik}\end{pmatrix}; \vec{0}, \Sigma_{ab}\Bigg) \cdot \text{dIWishart}(\Sigma_{ab};\nu_{ab} ,S_{abk}^{-1})\\
&amp;\sim \text{IWishart}\left(\Sigma_{abk}; \nu_{ab} + n_k,\left[S_{ab} + \sum_{i=1}^{n_k}\begin{pmatrix} a_{ik}\\ b_{ik}\end{pmatrix}\begin{pmatrix} a_{ik}\\ b_{ik}\end{pmatrix}^T\right]^{-1}\right)
\end{align*}\]</span></p>
</section>
<section id="update-sigma_uv" class="level3">
<h3 class="anchored" data-anchor-id="update-sigma_uv">Update <span class="math inline">\(\Sigma_{uv}\)</span></h3>
<p><span class="math display">\[\begin{align*}
p(\Sigma_{uvk}\mid \vec{Y}, \dots) &amp;\propto \prod_{i=1}^{n_k}\text{dMVN}\Bigg(\begin{pmatrix} u_{ik}\\ v_{ik}\end{pmatrix}; \vec{0}, \Sigma_{uv}\Bigg) \cdot \text{dIWishart}\left(\Sigma_{uvk};\nu_{uv} ,S_{uv}^{-1}\right)\\
&amp;\sim \text{IWishart}\left(\Sigma_{uvk}; \nu_{uv} + n_k,\left[S_{uv} + \sum_{i=1}^{n_k}\begin{pmatrix} u_{ik}\\ v_{ik}\end{pmatrix}\begin{pmatrix} u_{ik}\\ v_{ik}\end{pmatrix}^T\right]^{-1}\right)
\end{align*}\]</span></p>
</section>
</section>
<section id="coding-temporary" class="level2">
<h2 class="anchored" data-anchor-id="coding-temporary">Coding (Temporary)</h2>
<p>For the following function, two main arguments are required: data and edge_covariate. Both arguments should follow a list format. For now, the argument, edge_covariate, takes only one edge-specific covariate.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>hsvd <span class="ot">=</span> <span class="cf">function</span>(data, edge_covariate, <span class="at">dyad_dep =</span> T, <span class="at">num_iter =</span> <span class="dv">1000</span>, <span class="at">verbose =</span> T, <span class="at">hier =</span> T){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>(<span class="fu">require</span>(tmvtnorm))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>(<span class="fu">require</span>(mvtnorm))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>(<span class="fu">require</span>(truncnorm))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>(<span class="fu">require</span>(MCMCpack))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  iternum <span class="ot">=</span> num_iter</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">=</span> data</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  COV <span class="ot">=</span> edge_covariate</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(Y)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  nk <span class="ot">=</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(Y, nrow))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Create a list to collect MCMC samples</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    Chain <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"beta"</span> <span class="ot">=</span> <span class="fu">list</span>(), </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"rho"</span> <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow=</span>iternum, <span class="at">ncol=</span>K), </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"sigma_ab"</span> <span class="ot">=</span> <span class="fu">list</span>(), <span class="st">"sigma_uv"</span> <span class="ot">=</span> <span class="fu">list</span>(),</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"U"</span> <span class="ot">=</span> <span class="fu">list</span>(), <span class="st">"V"</span> <span class="ot">=</span> <span class="fu">list</span>(), </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"a"</span> <span class="ot">=</span> <span class="fu">list</span>(), <span class="st">"b"</span> <span class="ot">=</span> <span class="fu">list</span>(), </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"z"</span> <span class="ot">=</span> <span class="fu">list</span>(), <span class="st">"mu"</span> <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow=</span>iternum, <span class="at">ncol=</span><span class="dv">2</span>),</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"s2"</span> <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow=</span>iternum, <span class="at">ncol=</span><span class="dv">2</span>))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      Chain<span class="sc">$</span>U[[i]] <span class="ot">=</span> Chain<span class="sc">$</span>V[[i]] <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iternum){</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>U[[i]][[j]] <span class="ot">=</span> Chain<span class="sc">$</span>V[[i]][[j]] <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>      Chain<span class="sc">$</span>beta[[i]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow=</span>iternum,<span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      Chain<span class="sc">$</span>a[[i]] <span class="ot">=</span> Chain<span class="sc">$</span>b[[i]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="at">nrow=</span>iternum, <span class="at">ncol=</span>nk[i])</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initial points for parameters</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>      beta0 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,K)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>      beta1 <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,K)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>      beta <span class="ot">=</span> <span class="fu">cbind</span>(beta0,beta1)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      mu0 <span class="ot">=</span> mu <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>      s02 <span class="ot">=</span> s2 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>      <span class="co"># sigma_uv</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>      sigma_uv <span class="ot">=</span>  <span class="fu">matrix</span>(<span class="fl">0.5</span>,<span class="dv">4</span>,<span class="dv">4</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">diag</span>(sigma_uv) <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Random Initial points for U and V</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      U <span class="ot">=</span> V <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        U[[i]] <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">rmvnorm</span>(nk[i],<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),sigma_uv[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]),<span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        V[[i]] <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">rmvnorm</span>(nk[i],<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),sigma_uv[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]),<span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create Starting points for z, a, b</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">=</span> a <span class="ot">=</span> b <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># sigma_ab</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      sigma_ab <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="dv">1</span>),<span class="dv">2</span>,<span class="dv">2</span>) </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      <span class="co"># fill in z,a,b with random numbers</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        z[[k]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(nk[k]<span class="sc">*</span>nk[k]), <span class="at">ncol=</span>nk[k],<span class="at">nrow=</span>nk[k])</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">diag</span>(z[[k]]) <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        a[[k]] <span class="ot">=</span> b[[k]] <span class="ot">=</span> <span class="fu">numeric</span>(nk[k])</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>      <span class="co">#initial for rho, beta0, beta1</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (dyad_dep <span class="sc">==</span> T){</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        rho <span class="ot">=</span> <span class="fu">rep</span>(<span class="fl">0.5</span>,K)</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> rho <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>,K)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMC</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  ptm <span class="ot">&lt;-</span> <span class="fu">proc.time</span>()</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">diag</span>(Y[[k]]) <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">diag</span>(Cov1[[k]]) <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">diag</span>(z[[k]]) <span class="ot">=</span> <span class="dv">0</span> </span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (sim <span class="cf">in</span> (<span class="dv">1</span>)<span class="sc">:</span>(iternum)){</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        index <span class="ot">=</span> <span class="fu">which</span>(<span class="fu">diag</span>(nk[k]) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update Z </span><span class="al">###</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        etas <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">cbind</span>(<span class="dv">1</span>,<span class="fu">c</span>(Cov1[[k]])) <span class="sc">%*%</span> beta[k,] <span class="sc">+</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rowSums</span>(U[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(U[[k]])), nk[k]),] <span class="sc">*</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>                                  V[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(V[[k]])), <span class="at">each=</span>nk[k]),]) <span class="sc">+</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(a[[k]], nk[k]) <span class="sc">+</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">rep</span>(b[[k]], <span class="at">each=</span>nk[k]),</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>                      nk[k],nk[k])</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        <span class="fu">diag</span>(etas) <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        m <span class="ot">=</span> <span class="fu">c</span>(etas) <span class="sc">+</span> rho[k]<span class="sc">*</span>( <span class="fu">c</span>(<span class="fu">t</span>(z[[k]])) <span class="sc">-</span> <span class="fu">c</span>(<span class="fu">t</span>(etas)))</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        z[[k]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rtruncnorm</span>(<span class="dv">1</span>,</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">a =</span> <span class="fu">ifelse</span>(<span class="fu">c</span>(Y[[k]]), <span class="dv">0</span>, <span class="sc">-</span><span class="cn">Inf</span>),</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">b =</span> <span class="fu">ifelse</span>(<span class="fu">c</span>(Y[[k]]), <span class="cn">Inf</span>, <span class="dv">0</span>),</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">mean =</span> m, <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">-</span>rho[k]<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>                        <span class="at">nrow =</span> nk[k], <span class="at">ncol =</span> nk[k])</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update beta0, beta1 </span><span class="al">###</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>        sigma_beta <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(s02,<span class="dv">0</span>,<span class="dv">0</span>,s2),<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>        zbar <span class="ot">=</span> <span class="fu">matrix</span>(</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(z[[k]])<span class="sc">-</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(a[[k]], nk[k]) <span class="sc">-</span> </span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rep</span>(b[[k]], <span class="at">each=</span>nk[k]) <span class="sc">-</span> </span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rowSums</span>(U[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(U[[k]])), nk[k]),] <span class="sc">*</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>                      V[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(V[[k]])), <span class="at">each=</span>nk[k]),]),</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>          nk[k],nk[k])</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>        <span class="fu">diag</span>(zbar) <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        rp <span class="ot">=</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span>rho[k]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">=</span> (<span class="fu">cbind</span>(<span class="dv">1</span>,<span class="fu">c</span>(Cov1[[k]])) <span class="sc">-</span> rho[k]<span class="sc">*</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">c</span>(<span class="fu">t</span>(Cov1[[k]])))))[<span class="sc">-</span>index,]</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        V_beta <span class="ot">=</span> <span class="fu">solve</span>( <span class="fu">solve</span>(sigma_beta) <span class="sc">+</span> rp<span class="sc">*</span><span class="fu">crossprod</span>(X))</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>        mu_beta <span class="ot">=</span> V_beta <span class="sc">%*%</span> ( <span class="fu">solve</span>(sigma_beta) <span class="sc">%*%</span> <span class="fu">c</span>(mu0,mu) </span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>                               <span class="sc">+</span> rp <span class="sc">*</span> <span class="fu">crossprod</span>(X, <span class="fu">c</span>(zbar)[<span class="sc">-</span>index] <span class="sc">-</span> rho[k] <span class="sc">*</span> <span class="fu">c</span>(<span class="fu">t</span>(zbar))[<span class="sc">-</span>index]))</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>        beta[k,] <span class="ot">=</span> <span class="fu">rmvnorm</span>(<span class="dv">1</span>, mu_beta, V_beta)</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update a, b </span><span class="al">###</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>        zhat <span class="ot">=</span> <span class="fu">matrix</span>( <span class="fu">c</span>(z[[k]]) <span class="sc">-</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">c</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">c</span>(Cov1[[k]]))<span class="sc">%*%</span>beta[k,]) <span class="sc">-</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rowSums</span>(U[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(U[[k]])), nk[k]),] <span class="sc">*</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>                                   V[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(V[[k]])), <span class="at">each=</span>nk[k]),]),</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>                       nk[k], nk[k])</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>        S11 <span class="ot">=</span> sigma_ab[<span class="dv">1</span>,<span class="dv">1</span>]; S22 <span class="ot">=</span> sigma_ab[<span class="dv">2</span>,<span class="dv">2</span>]; S12 <span class="ot">=</span> S21 <span class="ot">=</span> sigma_ab[<span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>        sigma2_a <span class="ot">=</span> S11 <span class="sc">-</span> S12<span class="sc">%*%</span> <span class="fu">solve</span>(S22) <span class="sc">%*%</span> S21</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>        sigma2_b <span class="ot">=</span> S22 <span class="sc">-</span> S21<span class="sc">%*%</span> <span class="fu">solve</span>(S11) <span class="sc">%*%</span> S12</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>nk[k])){</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>          theta_ai <span class="ot">=</span> <span class="fu">sum</span>(zhat[i,<span class="sc">-</span>i] <span class="sc">-</span> rho[k]<span class="sc">*</span>(zhat[<span class="sc">-</span>i,i] <span class="sc">-</span> a[[k]][<span class="sc">-</span>i] <span class="sc">-</span> b[[k]][i]) <span class="sc">-</span> b[[k]][<span class="sc">-</span>i])</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>          m_ab <span class="ot">=</span> S12<span class="sc">%*%</span><span class="fu">solve</span>(S22)<span class="sc">%*%</span>b[[k]][i]</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>          A0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>sigma2_a; A1 <span class="ot">=</span> (nk[k]<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> rp</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>          m0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>sigma2_a<span class="sc">*</span>m_ab; m1 <span class="ot">=</span> rp <span class="sc">*</span> theta_ai</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>          mu_ai <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(A0<span class="sc">+</span>A1)<span class="sc">*</span>(m0<span class="sc">+</span>m1)</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>          s2_ai <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(A0<span class="sc">+</span>A1)</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>          a[[k]][i] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_ai, <span class="fu">sqrt</span>(s2_ai))</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>          theta_bi <span class="ot">=</span> <span class="fu">sum</span>(zhat[<span class="sc">-</span>i,i] <span class="sc">-</span> rho[k]<span class="sc">*</span>(zhat[i,<span class="sc">-</span>i] <span class="sc">-</span> b[[k]][<span class="sc">-</span>i] <span class="sc">-</span> a[[k]][i]) <span class="sc">-</span> a[[k]][<span class="sc">-</span>i])</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>          m_ba <span class="ot">=</span> S21<span class="sc">%*%</span><span class="fu">solve</span>(S11)<span class="sc">%*%</span>a[[k]][i]</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>          A0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>sigma2_b; A1 <span class="ot">=</span> (nk[k]<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> rp</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>          m0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>sigma2_b<span class="sc">*</span>m_ba; m1 <span class="ot">=</span> rp <span class="sc">*</span> theta_bi</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>          mu_bi <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(A0<span class="sc">+</span>A1)<span class="sc">*</span>(m0<span class="sc">+</span>m1)</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>          s2_bi <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(A0<span class="sc">+</span>A1)</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>          b[[k]][i] <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_bi, <span class="fu">sqrt</span>(s2_bi))</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update U, V </span><span class="al">###</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>        ztilde <span class="ot">=</span> <span class="fu">matrix</span>( <span class="fu">c</span>(z[[k]]) <span class="sc">-</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">c</span>(Cov1[[k]]))<span class="sc">%*%</span>beta[k,] <span class="sc">-</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">rep</span>(a[[k]], nk[k]) <span class="sc">-</span> <span class="fu">rep</span>(b[[k]], <span class="at">each=</span>nk[k]),</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>                         nk[k], nk[k])</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>        <span class="fu">diag</span>(ztilde) <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>        S11 <span class="ot">=</span> sigma_uv[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]; S22 <span class="ot">=</span> sigma_uv[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]; S12 <span class="ot">=</span> sigma_uv[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]; S21 <span class="ot">=</span> sigma_uv[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>        sigma2_u <span class="ot">=</span> S11 <span class="sc">-</span> S12<span class="sc">%*%</span> <span class="fu">solve</span>(S22) <span class="sc">%*%</span> S21</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>        sigma2_v <span class="ot">=</span> S22 <span class="sc">-</span> S21<span class="sc">%*%</span> <span class="fu">solve</span>(S11) <span class="sc">%*%</span> S12</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>nk[k])){</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>          Theta_V <span class="ot">=</span> V[[k]][<span class="sc">-</span>i,]</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>          mu_u <span class="ot">=</span> ztilde[i,<span class="sc">-</span>i] <span class="sc">-</span> <span class="fu">c</span>(rho[k]<span class="sc">*</span>(ztilde[<span class="sc">-</span>i,i] <span class="sc">-</span> U[[k]][<span class="sc">-</span>i,] <span class="sc">%*%</span> V[[k]][i,]))</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>          mu_uv <span class="ot">=</span> S12<span class="sc">%*%</span><span class="fu">solve</span>(S22)<span class="sc">%*%</span>V[[k]][i,]</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>          A0 <span class="ot">=</span> <span class="fu">solve</span>(sigma2_u); A1 <span class="ot">=</span> rp<span class="sc">*</span><span class="fu">crossprod</span>(Theta_V)</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>          m0 <span class="ot">=</span> <span class="fu">solve</span>(sigma2_u)<span class="sc">%*%</span>mu_uv; m1 <span class="ot">=</span> rp<span class="sc">*</span><span class="fu">crossprod</span>(Theta_V,mu_u)</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>          mu_ui <span class="ot">=</span> <span class="fu">solve</span>(A0<span class="sc">+</span>A1)<span class="sc">%*%</span>(m0<span class="sc">+</span>m1)</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>          U[[k]][i,] <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>,mu_ui,<span class="fu">solve</span>(A0<span class="sc">+</span>A1))</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>          Theta_U <span class="ot">=</span> U[[k]][<span class="sc">-</span>i,]</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>          mu_v <span class="ot">=</span> ztilde[<span class="sc">-</span>i,i] <span class="sc">-</span> <span class="fu">c</span>(rho[k]<span class="sc">*</span>(ztilde[i,<span class="sc">-</span>i] <span class="sc">-</span> V[[k]][<span class="sc">-</span>i,] <span class="sc">%*%</span> U[[k]][i,]))</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>          mu_vu <span class="ot">=</span> S21<span class="sc">%*%</span><span class="fu">solve</span>(S11)<span class="sc">%*%</span>U[[k]][i,]</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>          A0 <span class="ot">=</span> <span class="fu">solve</span>(sigma2_v); A1 <span class="ot">=</span> rp<span class="sc">*</span><span class="fu">crossprod</span>(Theta_U)</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>          m0 <span class="ot">=</span> <span class="fu">solve</span>(sigma2_v)<span class="sc">%*%</span>mu_vu; m1 <span class="ot">=</span> rp<span class="sc">*</span><span class="fu">crossprod</span>(Theta_U,mu_v)</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>          mu_vi <span class="ot">=</span> <span class="fu">solve</span>(A0<span class="sc">+</span>A1)<span class="sc">%*%</span>(m0<span class="sc">+</span>m1)</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>          V[[k]][i,] <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>,mu_vi,<span class="fu">solve</span>(A0<span class="sc">+</span>A1))</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update rho </span><span class="al">###</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (dyad_dep <span class="sc">==</span> T){</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>        etilde <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(z[[k]]) <span class="sc">-</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">c</span>(Cov1[[k]]))<span class="sc">%*%</span>beta[k,] <span class="sc">-</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">rep</span>(a[[k]], nk[k]) <span class="sc">-</span> <span class="fu">rep</span>(b[[k]], <span class="at">each=</span>nk[k]) <span class="sc">-</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">rowSums</span>(U[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(U[[k]])), nk[k]),] <span class="sc">*</span> </span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>                                  V[[k]][<span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(V[[k]])), <span class="at">each=</span>nk[k]),]),</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>                        nk[k],nk[k])</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>        <span class="fu">diag</span>(etilde) <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>        EM<span class="ot">&lt;-</span><span class="fu">cbind</span>(etilde[<span class="fu">upper.tri</span>(etilde)],<span class="fu">t</span>(etilde)[<span class="fu">upper.tri</span>(etilde)] )</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>        emcp<span class="ot">&lt;-</span><span class="fu">sum</span>(EM[,<span class="dv">1</span>]<span class="sc">*</span>EM[,<span class="dv">2</span>])</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>        emss<span class="ot">&lt;-</span><span class="fu">sum</span>(EM<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>        m<span class="ot">&lt;-</span> <span class="fu">nrow</span>(EM)</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>        sr <span class="ot">=</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span><span class="fu">cor</span>(etilde)[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">sqrt</span>(m)</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>        rho_p <span class="ot">=</span> rho[k] <span class="sc">+</span> sr <span class="sc">*</span> <span class="fu">qnorm</span>( <span class="fu">runif</span>(<span class="dv">1</span>,<span class="fu">pnorm</span>( (<span class="sc">-</span><span class="dv">1</span><span class="sc">-</span>rho[k])<span class="sc">/</span>sr), <span class="fu">pnorm</span>( (<span class="dv">1</span><span class="sc">-</span>rho[k])<span class="sc">/</span>sr)))</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>        rd <span class="ot">&lt;-</span> (<span class="sc">-</span>.<span class="dv">5</span><span class="sc">*</span>(m<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>rho_p<span class="sc">^</span><span class="dv">2</span>)<span class="sc">+</span>(emss<span class="dv">-2</span><span class="sc">*</span>rho_p<span class="sc">*</span>emcp)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>rho_p<span class="sc">^</span><span class="dv">2</span>)))<span class="sc">-</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>          (<span class="sc">-</span>.<span class="dv">5</span><span class="sc">*</span>(m<span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>rho[k]<span class="sc">^</span><span class="dv">2</span> )<span class="sc">+</span>(emss<span class="dv">-2</span><span class="sc">*</span>rho[k]<span class="sc">*</span>emcp )<span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>rho[k]<span class="sc">^</span><span class="dv">2</span> )))<span class="sc">+</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>          ( (<span class="sc">-</span>.<span class="dv">5</span><span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>rho_p<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">-</span> (<span class="sc">-</span>.<span class="dv">5</span><span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>rho[k]<span class="sc">^</span><span class="dv">2</span>)) )</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">log</span>(<span class="fu">runif</span>(<span class="dv">1</span>)) <span class="sc">&lt;</span> rd) rho[k] <span class="ot">=</span> rho_p</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>rho[sim,k] <span class="ot">=</span> rho[k]</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>beta[[k]][sim,] <span class="ot">=</span> beta[k,]</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>U[[k]][[sim]] <span class="ot">=</span> U[[k]]</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>V[[k]][[sim]] <span class="ot">=</span> V[[k]]</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>a[[k]][sim,] <span class="ot">=</span> a[[k]]</span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>b[[k]][sim,] <span class="ot">=</span> b[[k]]</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hier <span class="sc">==</span> T){</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update Sigma_ab </span><span class="al">###</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>        Sab0 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">ncol=</span><span class="dv">2</span>); nuab0 <span class="ot">=</span> <span class="dv">2</span><span class="sc">+</span><span class="dv">2</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>        S_theta_ab <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rowSums</span>(<span class="fu">apply</span>(<span class="fu">do.call</span>(rbind,<span class="fu">Map</span>(cbind,a,b)) ,<span class="dv">1</span>,tcrossprod)),<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>        sigma_ab <span class="ot">=</span> <span class="fu">riwish</span>(<span class="at">v =</span> nuab0 <span class="sc">+</span> <span class="fu">sum</span>(nk) , <span class="at">S =</span> Sab0 <span class="sc">+</span> S_theta_ab)</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update Sigma_uv </span><span class="al">###</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>        Suv0 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">5</span>,<span class="dv">16</span>)),<span class="at">ncol=</span><span class="dv">4</span>); <span class="fu">diag</span>(Suv0) <span class="ot">=</span> <span class="dv">10</span>; nuuv0 <span class="ot">=</span> <span class="dv">4</span><span class="sc">+</span><span class="dv">2</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>        S_theta_uv <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rowSums</span>(<span class="fu">apply</span>(<span class="fu">do.call</span>(rbind,<span class="fu">Map</span>(cbind,U,V)),<span class="dv">1</span>,tcrossprod)),<span class="dv">4</span>,<span class="dv">4</span>)</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>        sigma_uv <span class="ot">=</span> <span class="fu">riwish</span>(<span class="at">v =</span>nuuv0 <span class="sc">+</span> <span class="fu">sum</span>(nk), <span class="at">S=</span> Suv0 <span class="sc">+</span> S_theta_uv)</span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update mu0 (mean of beta0) </span><span class="al">###</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>        s00 <span class="ot">=</span> <span class="dv">1</span>; mu00 <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>        s02_n<span class="ot">=</span> (<span class="dv">1</span><span class="sc">/</span>s00 <span class="sc">+</span> (K <span class="sc">/</span> s02))<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>        mu0_n<span class="ot">=</span> (mu00 <span class="sc">/</span> s00 <span class="sc">+</span> <span class="fu">sum</span>(beta[,<span class="dv">1</span>]) <span class="sc">/</span> s02) <span class="sc">*</span> s02_n</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>        mu0 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu0_n, <span class="fu">sqrt</span>(s02_n)) </span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update mu (mean of beta1) </span><span class="al">###</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>        s10 <span class="ot">=</span> <span class="dv">1</span>; mu10 <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>        s2_n<span class="ot">=</span> (<span class="dv">1</span><span class="sc">/</span>s10 <span class="sc">+</span> (K <span class="sc">/</span> s2))<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>        mu_n<span class="ot">=</span> (mu10 <span class="sc">/</span> s10 <span class="sc">+</span> <span class="fu">sum</span>(beta[,<span class="dv">2</span>]) <span class="sc">/</span> s2) <span class="sc">*</span> s2_n</span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>        mu <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_n, <span class="fu">sqrt</span>(s2_n))</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update S0 (var of beta0) </span><span class="al">###</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>        c <span class="ot">=</span> <span class="dv">5</span>; d <span class="ot">=</span> <span class="fl">0.25</span>  <span class="co"># Hyperparameters</span></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>        nu0_n <span class="ot">=</span> c <span class="sc">+</span> K</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>        ss0_n <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>nu0_n <span class="sc">*</span> (c <span class="sc">*</span> d <span class="sc">+</span> (K<span class="dv">-1</span>)<span class="sc">*</span><span class="fu">var</span>(beta[,<span class="dv">1</span>]) <span class="sc">+</span> K<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>)<span class="sc">*</span>(<span class="fu">mean</span>(beta[,<span class="dv">1</span>])<span class="sc">-</span>mu0)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>        s02 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, nu0_n<span class="sc">/</span><span class="dv">2</span>, nu0_n<span class="sc">*</span>ss0_n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>        <span class="do">### Update S1 (var of beta1) </span><span class="al">###</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>        nu_n <span class="ot">=</span> c <span class="sc">+</span> K</span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>        ss_n <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>nu_n <span class="sc">*</span> (c <span class="sc">*</span> d <span class="sc">+</span> (K<span class="dv">-1</span>)<span class="sc">*</span><span class="fu">var</span>(beta[,<span class="dv">2</span>]) <span class="sc">+</span> K<span class="sc">/</span>(K<span class="sc">+</span><span class="dv">1</span>)<span class="sc">*</span>(<span class="fu">mean</span>(beta[,<span class="dv">2</span>])<span class="sc">-</span>mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>        s2 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, nu_n<span class="sc">/</span><span class="dv">2</span>, nu_n<span class="sc">*</span>ss_n<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>sigma_ab[[sim]] <span class="ot">=</span> sigma_ab</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>sigma_uv[[sim]] <span class="ot">=</span> sigma_uv</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>mu[sim,] <span class="ot">=</span> <span class="fu">cbind</span>(mu0,mu)</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>        Chain<span class="sc">$</span>s2[sim,] <span class="ot">=</span> <span class="fu">cbind</span>(s02,s2)</span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (sim <span class="sc">%%</span> <span class="dv">100</span> <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> verbose <span class="sc">==</span> T) {</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>        ptm2 <span class="ot">=</span> (<span class="fu">proc.time</span>() <span class="sc">-</span> ptm)[<span class="dv">3</span>]</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(sim,<span class="st">"/"</span>,iternum,<span class="st">"   (time:"</span>, ptm2, <span class="st">")"</span>, </span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>            <span class="st">"     (estimated time left:"</span>, ptm2<span class="sc">*</span>(iternum<span class="sc">-</span>sim)<span class="sc">/</span><span class="dv">100</span>, <span class="st">") </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>        ptm <span class="ot">=</span> <span class="fu">proc.time</span>()</span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(Chain)</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="test-with-simulated-data" class="level2">
<h2 class="anchored" data-anchor-id="test-with-simulated-data">Test (with simulated data)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 networks with sizes of 20 and 60. suppressMessages(library(mvtnorm))</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>K <span class="ot">=</span> <span class="dv">2</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Cov1 <span class="ot">=</span> <span class="fu">list</span>() </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>nk <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">60</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){ </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  Cov1[[i]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(nk[i]<span class="sc">^</span><span class="dv">2</span>),nk[i],nk[i]) </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">diag</span>(Cov1[[i]]) <span class="ot">=</span> <span class="cn">NA</span> </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The simulated dataset has 6 networks: Network 1 is the smallest one with 5 nodes, and the other 5 networks have 20 nodes. As discussed previously, we can expect shrinkage effect by hierarchical modeling and smaller variance in parameter estimation for Network 1. The plot above displays 95 percentiles of <span class="math inline">\(\beta_1\)</span>s for each network and the blue dashed lines are the true value. Given the assumption that there truely exists hierarchical structure, the individual network analysis not only misses some of the true <span class="math inline">\(\beta_1\)</span>s, but also larger variance for small network. Furthermore, given that all mean posterior estimates of networks in hierarchical model have much more similar values than those in individual model, we can easily conclude that the shrinkage exists.</p>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>The hierarhical network modeling allows one obtain more stable parameter estimations by adding the assumption that the parameters for each network are generated by some hyperparameters. This assumption is plausible because the networks in a dataset may behave similarly each other. For example, in educational research settings, networks of multiple schools are usually collected, and it is reasonable to consider the schools are somehow conneted each other and the actors of each school behave similarly. And hierarchical network analysis allows one make the connection of those networks.</p>
<p>For further research, the computation speed should be optimized by parallel computing or vectorization. Moreover, with dyadic dependence, <span class="math inline">\(\rho\)</span>, every Gibbs sampler simulation was done by fixing the other element. This may lead to bad mixing in MCMC with high autocorrelation. So it would be much faster and nicer in mixing if the MCMC can be done with the joint distribution itself.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>